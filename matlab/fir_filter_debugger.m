 %Engineer: Amey Kulkarni
 %Module Name:  fir_filter_debugger
 %Project Name: Spectral Doppler Ultrasound Imaging System

clear all
close all
clc
format compact

% filter coefficients
coeffs_B = [0.0300594734259009,-0.0115375559857447,-0.00388938412414256,0.00350096286281524,0.00874053738870243,0.0107802349807998,0.00940566410661252,0.00513344721792368,-0.00108383273670873,-0.00806288747329538,-0.0146919559877883,-0.0200438439082470,-0.0235008737653277,-0.0247436389352284,-0.0238402721019534,-0.0210711490334906,-0.0169818906732913,-0.0122562264695017,-0.00764600931871177,-0.00389394429071837,-0.00161386596434338,-0.00121655727381419,-0.00281990679252409,-0.00621950493695609,-0.0109125113068831,-0.0161328439975859,-0.0209835985158980,-0.0245794198846927,-0.0262023376129241,-0.0254367265305507,-0.0222922374050886,-0.0171994096599491,-0.0110217141391948,-0.00487579577070650,-2.02452672593564e-05,0.00243879154293804,0.00170766848704199,-0.00250090474202130,-0.00986891798483064,-0.0194499649339163,-0.0297723241337513,-0.0389975866631518,-0.0451846002005578,-0.0466181111842410,-0.0420219945579665,-0.0309076525748373,-0.0134832370738942,0.00900097514703907,0.0346354982822630,0.0609736080074280,0.0851936584387758,0.104739107696998,0.117440923701292,0.121861309898371,0.117440923701292,0.104739107696998,0.0851936584387758,0.0609736080074280,0.0346354982822630,0.00900097514703907,-0.0134832370738942,-0.0309076525748373,-0.0420219945579665,-0.0466181111842410,-0.0451846002005578,-0.0389975866631518,-0.0297723241337513,-0.0194499649339163,-0.00986891798483064,-0.00250090474202130,0.00170766848704199,0.00243879154293804,-2.02452672593564e-05,-0.00487579577070650,-0.0110217141391948,-0.0171994096599491,-0.0222922374050886,-0.0254367265305507,-0.0262023376129241,-0.0245794198846927,-0.0209835985158980,-0.0161328439975859,-0.0109125113068831,-0.00621950493695609,-0.00281990679252409,-0.00121655727381419,-0.00161386596434338,-0.00389394429071837,-0.00764600931871177,-0.0122562264695017,-0.0169818906732913,-0.0210711490334906,-0.0238402721019534,-0.0247436389352284,-0.0235008737653277,-0.0200438439082470,-0.0146919559877883,-0.00806288747329538,-0.00108383273670873,0.00513344721792368,0.00940566410661252,0.0107802349807998,0.00874053738870243,0.00350096286281524,-0.00388938412414256,-0.0115375559857447,0.0300594734259009;];
coeffs_A = 1;

%signal = 0:199;
signal = zeros(1,128);
signal(1) = 32;

x_vals = 1:128;

filtered_signal = filter(coeffs_B, coeffs_A, signal);

% The output of the fir_filter module, copied from ISim.
%hw_output = [15776, -6032, -2048, 1840, 4560, 5664, 4928, 2672, -576, -4240, -7712, -10480, -12320, -12944, -12480, -11056, -8912, -6448, -3984, -2048, -832, -624, -1472, -3248, -5712, -8448, -11008, -12896, -13744, -13312, -11696, -9024, -5760, -2576, 0, 1264, 896, -1312, -5184, -10176, -15616, -20448, -23696, -24432, -22016, -16208, -7072, 4720, 18144, 31984, 44672, 54896, 61552, 63904, 61552, 54896, 44672, 31984, 18144, 4720, -7072, -16208, -22016, -24432, -23696, -20448, -15616, -10176, -5184, -1312, 896, 1264, 0, -2576, -5760, -9024, -11696, -13312, -13744, -12896, -11008, -8448, -5712, -3248, -1472, -624, -832, -2048, -3984, -6448, -8912, -11056, -12480, -12944, -12320, -10480, -7712, -4240, -576, 2672, 4928, 5664, 4560, 1840, -2048, -6032, 15776, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
%plot(x_vals, filtered_signal, '+', x_vals, hw_output/2^14, '-');

% turn 1D recieved signal into a 2D matrix, size becomes 128x251
filtered_signal_2D = reshape(filtered_signal,128,[]);

windowed_signal = filtered_signal_2D .* ...
    repmat(hamming(128), 1, size(filtered_signal_2D,2));

%round(windowed_signal * 2^22)

% WORKING
%hw_windowed = [2584799, -992640, -344960, 317718, 828002, 1090497, 1010394, 583739, -136314, -1080024, -2134778, -3138546, -4004385, -4551464, -4754100, -4543650, -3948990, -3073491, -2036948, -1126976, -489710, -381919, -984630, -2297043, -4291936, -6734112, -9263576, -11433110, -12796212, -13021216, -11965795, -9664422, -6437160, -2980240, 0, 1568424, 1167096, -1768412, -7219206, -14619096, -23109240, -31125051, -37022200, -39153345, -36162656, -27205596, -12138646, 8237439, 32374566, 58047894, 82444968, 102819395, 116893401, 122933323, 119739441, 107888935, 88623664, 63927009, 36530109, 9524424, -14383785, -33044836, -45031664, -49997101, -48489980, -41824467, -31869328, -20697030, -10496304, -2641507, 1791748, 2475876, 0, -4981360, -11080620, -17141934, -21882845, -24568128, -24927474, -23010494, -19276728, -14500464, -9570348, -5308762, -2360490, -950570, -1266434, -3030720, -5700528, -8957163, -11990696, -14380290, -15684240, -15650152, -14342405, -11694174, -8259311, -4327356, -563418, 2475724, 4368980, 4766433, 3622136, 1374384, -1455552, -4024140, 9909793, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
%plot(x_vals, windowed_signal, '-', x_vals, hw_windowed / 2^30, '-');

% Last tried
%hw_windowed = [10096, -1610616614, 234879676, 1241, 3234, 4259, 3946, 2280, -1795162645, -167776379, -1711284371, 2113916956, -1593851163, 33536652, -1644185739, 1912584875, 2097136574, -1157639910, 721412331, -922751283, -1828718457, -2063599060, -1660948231, -687874829, 805289602, -1543530178, 822047398, -771796597, -2080424770, 1157577039, 251611498, -553685880, -1308647994, -2063609210, 0, 6126, 4558, 2080367876, 318738903, -1811996434, -83976351, 1157506321, 1845349142, 1929226897, 1375590451, 100557024, -1912650041, 32177, 126463, 226749, 322050, 401638, 456614, 480208, 467732, 421441, 346186, 249714, 142695, 37204, 1023353989, 436078534, -1392684833, -151190246, -151184358, -1392672305, 436083126, 1023329328, 402612182, -1426073679, 6999, 9671, 0, 989836285, 1996445420, 1929312879, 821998104, -1308718818, -100760669, 167682275, -453060132, -1912659267, 100625911, 1375710974, 1929370619, 1845490046, 1157622956, -83897919, -1811961596, 318732115, 2080327945, -771808110, 402591917, 1375670578, -2063653594, -1308668529, -553680391, 251641336, 1157625703, 9670, 17066, 18618, 14148, 5368, -687871542, -1660960104, 38710, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
%plot(x_vals, windowed_signal, '-', x_vals, hw_windowed / 2^22, '-');


%hw_windowed = [39, 346030064, 353239034, 4, 12, 16, 15, 8, 496304125, 536215535, 580517855, 629014480, 681639874, 738328506, 798883767, 863109050, 930938819, 1002110929, 1076559840, 1154023406, 1234370552, 1317339130, 1402798064, 1490485212, 1580203966, 1671692185, 1764818802, 1859256145, 1954807612, 2051342137, -2146500791, -2048983188, -1951268963, -1853554734, 0, 23, 17, -1468268571, -1374486639, -1282146528, -1191510369, -1102774747, -1016201781, -931988054, -850264616, -771359136, -695337146, 125, 493, 885, 1258, 1568, 1783, 1875, 1827, 1646, 1352, 975, 557, 145, -29556956, -15073785, -5440176, -590587, -590564, -5440127, -15073767, -29557052, -48758945, -72679465, 27, 37, 0, -214237261, -260636842, -311230726, -365887822, -424542583, -486932861, -552993120, -622526759, -695337182, -771358867, -850264146, -931987493, -1016201231, -1102774292, -1191510063, -1282146391, -1374486665, -1468268727, -1563295964, -1659371760, -1756233967, -1853554907, -1951269043, -2048983167, -2146500675, 2051342327, 37, 66, 72, 55, 20, 1490485225, 1402798018, 151, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
%plot(x_vals, windowed_signal, '-', x_vals, hw_windowed / 2^14, '-');


%hw_windowed = [39, 346030064, 353239034, 4, 12, 16, 15, 8, 496304125, 536215535, 580517855, 629014480, 681639874, 738328506, 798883767, 863109050, 930938819, 1002110929, 1076559840, 1154023406, 1234370552, 1317339130, 1402798064, 1490485212, 1580203966, 1671692185, 1764818802, 1859256145, 1954807612, 2051342137, -2146500791, -2048983188, -1951268963, -1853554734, 0, 23, 17, -1468268571, -1374486639, -1282146528, -1191510369, -1102774747, -1016201781, -931988054, -850264616, -771359136, -695337146, 125, 493, 885, 1258, 1568, 1783, 1875, 1827, 1646, 1352, 975, 557, 145, -29556956, -15073785, -5440176, -590587, -590564, -5440127, -15073767, -29557052, -48758945, -72679465, 27, 37, 0, -214237261, -260636842, -311230726, -365887822, -424542583, -486932861, -552993120, -622526759, -695337182, -771358867, -850264146, -931987493, -1016201231, -1102774292, -1191510063, -1282146391, -1374486665, -1468268727, -1563295964, -1659371760, -1756233967, -1853554907, -1951269043, -2048983167, -2146500675, 2051342327, 37, 66, 72, 55, 20, 1490485225, 1402798018, 151, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
%plot(x_vals, windowed_signal, '-', x_vals, hw_windowed / 2^14, '-');

%reconstructed_fd = zeros(size(rx_signal_2D_window));
%for n = 1:size(rx_signal_2D_window,2)
%    reconstructed_fd(:,n) = fft(rx_signal_2D_window(:,n),FFT_size);
%end

hw_windowed = [1262, -486, -169, 156, 405, 532, 493, 286, -67, -530, -1043, -1535, -1956, -2226, -2322, -2222, -1932, -1505, -999, -551, -240, -192, -481, -1128, -2102, -3289, -4524, -5583, -6256, -6359, -5851, -4719, -3144, -1465, 0, 775, 569, -864, -3526, -7139, -11284, -15198, -18090, -19131, -17658, -13298, -5928, 4035, 15807, 28357, 40256, 50219, 57091, 60026, 58481, 52695, 43273, 31229, 17836, 4666, -7024, -16152, -21989, -24429, -23693, -20423, -15562, -10106, -5126, -1290, 874, 1224, 0, -2448, -5411, -8371, -10700, -11997, -12186, -11236, -9413, -7081, -4687, -2606, -1153, -477, -619, -1480, -2795, -4385, -5866, -7032, -7659, -7652, -7004, -5719, -4033, -2121, -276, 1216, 2133, 2327, 1774, 676, -711, -1971, 4838, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
%figure;
%plot(x_vals, windowed_signal, '-', x_vals, hw_windowed / 2^14, '-');


matlab_fft = fft(windowed_signal, 128);
hw_fft = [122 + 0*1i; -1068 + -1427*1i; 1533 + 3403*1i; 39 + -3753*1i; -2182 + 3016*1i; 3696 + -1780*1i; -3638 + -255*1i; 2987 + 2405*1i; -1681 + -3252*1i; 329 + 1717*1i; 6 + -219*1i; -75 + -6*1i; -1 + -53*1i; 67 + 9*1i; 26 + 72*1i; -40 + 45*1i; -38 + -23*1i; 22 + -44*1i; 62 + 0*1i; 38 + 51*1i; -18 + 51*1i; -39 + -2*1i; -4 + -42*1i; 48 + -29*1i; 57 + 22*1i; 17 + 54*1i; -29 + 31*1i; -30 + -21*1i; 14 + -44*1i; 57 + -16*1i; 48 + 34*1i; 2 + 51*1i; -34 + 14*1i; -21 + -32*1i; 29 + -42*1i; 60 + -4*1i; 40 + 43*1i; -11 + 43*1i; -36 + 3*1i; -9 + -41*1i; 39 + -37*1i; 60 + 8*1i; 28 + 46*1i; -20 + 38*1i; -34 + -11*1i; 2 + -46*1i; 49 + -30*1i; 56 + 19*1i; 18 + 49*1i; -28 + 28*1i; -30 + -24*1i; 13 + -46*1i; 56 + -21*1i; 51 + 30*1i; 5 + 47*1i; -32 + 19*1i; -23 + -32*1i; 25 + -47*1i; 59 + -11*1i; 43 + 36*1i; -5 + 45*1i; -35 + 5*1i; -15 + -38*1i; 35 + -43*1i; 59 + 0*1i; 35 + 43*1i; -15 + 38*1i; -35 + -5*1i; -5 + -45*1i; 43 + -36*1i; 59 + 11*1i; 25 + 47*1i; -23 + 32*1i; -32 + -19*1i; 5 + -47*1i; 51 + -30*1i; 56 + 21*1i; 13 + 46*1i; -30 + 24*1i; -28 + -28*1i; 18 + -49*1i; 56 + -19*1i; 49 + 30*1i; 2 + 46*1i; -34 + 11*1i; -20 + -38*1i; 28 + -46*1i; 60 + -8*1i; 39 + 37*1i; -9 + 41*1i; -36 + -3*1i; -11 + -43*1i; 40 + -43*1i; 60 + 4*1i; 29 + 42*1i; -21 + 32*1i; -34 + -14*1i; 2 + -51*1i; 48 + -34*1i; 57 + 16*1i; 14 + 44*1i; -30 + 21*1i; -29 + -31*1i; 17 + -54*1i; 57 + -22*1i; 48 + 29*1i; -4 + 42*1i; -39 + 2*1i; -18 + -51*1i; 38 + -51*1i; 62 + 0*1i; 22 + 44*1i; -38 + 23*1i; -40 + -45*1i; 26 + -72*1i; 67 + -9*1i; -1 + 53*1i; -75 + 6*1i; 6 + 219*1i; 329 + -1717*1i; -1681 + 3252*1i; 2987 + -2405*1i; -3638 + 255*1i; 3696 + 1780*1i; -2182 + -3016*1i; 39 + 3753*1i; 1533 + -3403*1i; -1068 + 1427*1i];

%figure;
%plot(x_vals, matlab_fft, '-', x_vals, (hw_fft / 2^7), '-');

%figure;
%plot(x_vals, abs(matlab_fft) - abs(hw_fft / 2^7), '-');

figure;
difff(matlab_fft, (hw_fft / 2^7));
